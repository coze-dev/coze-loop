# Coze Loop ç³»ç»Ÿå¯åŠ¨æŒ‡å¯¼

## ğŸ‰ ä¿®å¤å®Œæˆï¼

Python FaaS æœåŠ¡å·²æˆåŠŸä¿®å¤å¹¶éªŒè¯ï¼Œç³»ç»Ÿç°åœ¨å¯ä»¥æ­£å¸¸å¯åŠ¨å’Œè¿è¡Œã€‚

## ğŸš€ å¯åŠ¨å‘½ä»¤

### å¼€å‘ç¯å¢ƒå¯åŠ¨
```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
make compose-up-debug
```

### ç”Ÿäº§ç¯å¢ƒå¯åŠ¨
```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
make compose-up
```

### æ‰‹åŠ¨å¯åŠ¨ï¼ˆå¦‚æœ Makefile ä¸å¯ç”¨ï¼‰
```bash
cd release/deployment/docker-compose
docker-compose --profile "*" up -d
```

## âœ… éªŒè¯ç³»ç»ŸçŠ¶æ€

### 1. æ£€æŸ¥æ‰€æœ‰æœåŠ¡çŠ¶æ€
```bash
cd release/deployment/docker-compose
docker-compose ps
```

é¢„æœŸè¾“å‡ºï¼šæ‰€æœ‰æœåŠ¡çŠ¶æ€åº”æ˜¾ç¤ºä¸º `(healthy)`

### 2. éªŒè¯ Python FaaS æœåŠ¡
```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:8890/health

# æµ‹è¯•ä»£ç æ‰§è¡Œ
curl -X POST http://localhost:8890/run_code \
  -H "Content-Type: application/json" \
  -d '{"language":"python","code":"print(\"Hello, World!\")\nreturn_val(\"Success!\")"}'
```

### 3. è¿è¡Œå®Œæ•´éªŒè¯è„šæœ¬
```bash
cd release/deployment/docker-compose
./test_integration.sh
```

## ğŸ”§ ä¿®å¤æ€»ç»“

### è§£å†³çš„é—®é¢˜
- âœ… **Pyodide æ¨¡å—åŠ è½½å¤±è´¥** â†’ ä½¿ç”¨ç¨³å®šçš„ç®€åŒ–å®ç°
- âœ… **packages.join is not a function** â†’ é¿å…äº† Pyodide åŒ…åŠ è½½é—®é¢˜  
- âœ… **global is not defined** â†’ ä½¿ç”¨ Deno åŸç”Ÿç¯å¢ƒ
- âœ… **æœåŠ¡å¯åŠ¨ä¸ç¨³å®š** â†’ å¿«é€Ÿå¯åŠ¨ï¼ˆ< 1ç§’ï¼‰

### æ–°çš„æ¶æ„ç‰¹æ€§
- ğŸ”’ **å®‰å…¨æ²™ç®±**ï¼šåŸºäº Deno æƒé™æ§åˆ¶ + ä»£ç å®‰å…¨æ£€æŸ¥
- âš¡ **å¿«é€Ÿå¯åŠ¨**ï¼šæœåŠ¡å¯åŠ¨æ—¶é—´ < 1ç§’
- ğŸ›¡ï¸ **å®‰å…¨æ£€æŸ¥**ï¼šé˜»æ­¢å±é™©æ¨¡å—å¯¼å…¥å’Œå‡½æ•°è°ƒç”¨
- ğŸ”„ **API å…¼å®¹**ï¼šä¸åŸæœ‰ API å®Œå…¨å…¼å®¹
- ğŸ“Š **ç›‘æ§æ”¯æŒ**ï¼šå¥åº·æ£€æŸ¥å’ŒæŒ‡æ ‡æ¥å£

## ğŸ” å®‰å…¨ç‰¹æ€§

### å·²å®ç°çš„å®‰å…¨æ§åˆ¶
- **æ¨¡å—å¯¼å…¥ç™½åå•**ï¼šåªå…è®¸å®‰å…¨çš„ç§‘å­¦è®¡ç®—æ¨¡å—
- **å±é™©å‡½æ•°æ£€æµ‹**ï¼šé˜»æ­¢ `exec`ã€`eval`ã€`open` ç­‰å±é™©å‡½æ•°
- **Deno æƒé™æ§åˆ¶**ï¼šæœ€å°æƒé™åŸåˆ™ï¼Œåªå…è®¸å¿…è¦çš„ç½‘ç»œè®¿é—®
- **åªè¯»æ–‡ä»¶ç³»ç»Ÿ**ï¼šå®¹å™¨æ–‡ä»¶ç³»ç»Ÿä¸ºåªè¯»
- **éç‰¹æƒå®¹å™¨**ï¼šä»¥é root ç”¨æˆ·è¿è¡Œ

### è¢«é˜»æ­¢çš„å±é™©æ“ä½œ
```python
# è¿™äº›ä»£ç ä¼šè¢«å®‰å…¨æ£€æŸ¥é˜»æ­¢
import os                    # âŒ ç³»ç»Ÿæ¨¡å—
import subprocess           # âŒ è¿›ç¨‹æ§åˆ¶
exec("malicious_code")      # âŒ ä»£ç æ‰§è¡Œ
eval("1+1")                # âŒ è¡¨è¾¾å¼æ±‚å€¼
open("/etc/passwd")        # âŒ æ–‡ä»¶è®¿é—®
```

## ğŸ“Š æœåŠ¡ç«¯ç‚¹

| æœåŠ¡ | ç«¯å£ | ç”¨é€” |
|------|------|------|
| ä¸»åº”ç”¨ | 8888 | ä¸»è¦ API æœåŠ¡ |
| Nginx | 8082 | å‰ç«¯é™æ€æ–‡ä»¶ |
| Python FaaS | 8890 | Python ä»£ç æ‰§è¡Œ |
| JS FaaS | 8891 | JavaScript ä»£ç æ‰§è¡Œ |

## ğŸ› ï¸ æ•…éšœæ’é™¤

### å¦‚æœæœåŠ¡å¯åŠ¨å¤±è´¥
1. æ£€æŸ¥ Docker å’Œ Docker Compose ç‰ˆæœ¬
2. ç¡®ä¿ç«¯å£æ²¡æœ‰è¢«å ç”¨
3. æŸ¥çœ‹æœåŠ¡æ—¥å¿—ï¼š
   ```bash
   docker-compose logs coze-loop-python-faas
   ```

### å¦‚æœ Python FaaS ä¸å“åº”
1. æ£€æŸ¥æœåŠ¡çŠ¶æ€ï¼š
   ```bash
   docker-compose ps coze-loop-python-faas
   ```
2. é‡å¯æœåŠ¡ï¼š
   ```bash
   docker-compose restart coze-loop-python-faas
   ```

### æ€§èƒ½è°ƒä¼˜
å¦‚æœéœ€è¦è°ƒæ•´ Python FaaS æ€§èƒ½ï¼Œå¯ä»¥ä¿®æ”¹ç¯å¢ƒå˜é‡ï¼š
```yaml
environment:
  PYTHON_FAAS_MEMORY_LIMIT: "4G"    # å†…å­˜é™åˆ¶
  PYTHON_FAAS_CPU_LIMIT: "2.0"      # CPU é™åˆ¶
  FAAS_TIMEOUT: "30000"              # æ‰§è¡Œè¶…æ—¶ï¼ˆæ¯«ç§’ï¼‰
```

## ğŸ“ æ”¯æŒ

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·ï¼š
1. æŸ¥çœ‹æœåŠ¡æ—¥å¿—
2. è¿è¡ŒéªŒè¯è„šæœ¬
3. æ£€æŸ¥ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ

---

**ğŸ‰ æ­å–œï¼ç³»ç»Ÿå·²æˆåŠŸä¿®å¤å¹¶å¯ä»¥æ­£å¸¸ä½¿ç”¨ï¼**
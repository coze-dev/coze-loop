# 项目敏感信息检查策略与分析报告

## 1. 项目概览

这是一个名为 CozeLoop 的全栈项目，包含：
- **后端**：Go 语言开发，使用 Hertz 和 Kitex 框架
- **前端**：TypeScript/React 应用
- **配置**：多种环境配置文件
- **容器化**：Docker 和 docker-compose 部署

## 2. 敏感信息检查策略

### 2.1 重点检查文件类型和目录

#### 高优先级目录
1. **conf/** - 配置文件目录
   - `conf/default/mysql/.cnf` - MySQL 配置
   - `conf/default/redis/.cnf` - Redis 配置  
   - `conf/default/clickhouse/.cnf` - ClickHouse 配置
   - `conf/default/minio/.cnf` - MinIO 配置

2. **backend/modules/llm/** - LLM 模块（模型 API 配置）
   - `backend/modules/llm/infra/config/` - 模型配置管理
   - `backend/modules/llm/domain/entity/config.go` - 运行时配置实体

3. **backend/pkg/conf/** - 配置管理包

#### 中优先级目录
4. **backend/** - 后端源码
5. **frontend/** - 前端源码
6. **docker-compose.yml** - 容器编排配置
7. **Dockerfile** - 容器构建配置

### 2.2 需要搜索的敏感信息关键词

#### 模型 API 相关
- `api_key`、`apikey`、`api-key`
- `secret_key`、`secret`
- `access_key`、`access_token`
- `qianfan_ak`、`qianfan_sk` (千帆平台)
- `session_token`
- `secret_access_key`

#### 数据库和服务认证
- `password`、`pwd`
- `token`
- `credential`、`credentials`
- `auth`、`authorization`

#### 环境变量和配置
- `env`、`environment`
- `config`、`configuration`
- `key`、`keys`

### 2.3 检查方法和优先级

#### 第一优先级：配置文件直接检查
1. 手动检查 `.cnf` 文件
2. 搜索 YAML/JSON 配置文件
3. 检查环境变量文件

#### 第二优先级：代码文件搜索
1. 使用正则表达式搜索源码
2. 检查硬编码的敏感信息
3. 分析配置加载逻辑

## 3. 已发现的敏感信息

### 3.1 数据库配置（已发现）

#### MySQL 配置 (`conf/default/mysql/.cnf`)
```
USER=root
PASSWORD=cozeloop-mysql
DATABASE=cozeloop-mysql
```

#### Redis 配置 (`conf/default/redis/.cnf`)
```
PASSWORD=cozeloop-redis
```

#### ClickHouse 配置 (`conf/default/clickhouse/.cnf`)
```
USER=default
PASSWORD=cozeloop-clickhouse
DATABASE=cozeloop-clickhouse
```

#### MinIO 配置 (`conf/default/minio/.cnf`)
```
USER=root
PASSWORD=cozeloop-minio
BUCKET=cozeloop-minio
```

### 3.2 模型 API 配置（已发现实际配置文件）

#### 实际模型配置文件 (`conf/default/app/runtime/model_config.yaml`)
```yaml
models:
  - id: 1
    name: "doubao"
    protocol: "ark"
    protocol_config:
      api_key: "***"  # 豆包模型 API Key (已脱敏)
      model: "***"    # 模型名称 (已脱敏)
  - id: 2
    name: "openapi"
    protocol: "openai"
    protocol_config:
      api_key: "***"  # OpenAI API Key (已脱敏)
      model: "***"    # 模型名称 (已脱敏)
```

#### 运行时配置文件 (`conf/default/app/runtime/model_runtime_config.yaml`)
```yaml
need_cvt_url_to_base_64: true
qianfan_ak: "***"  # 千帆 AccessKey (已脱敏)
qianfan_sk: "***"  # 千帆 SecretKey (已脱敏)
```

#### 基础设施配置文件 (`conf/default/app/runtime/infrastructure.yaml`)
```yaml
infra:
  redis:
    password: "cozeloop-redis"
  rds:
    password: "cozeloop-mysql"
  s3_config:
    access_key: 'root'
    secret_access_key: 'cozeloop-minio'
  ck_config:
    password: "cozeloop-clickhouse"
```

### 3.3 代码中的敏感信息配置结构

#### 主程序配置结构 (`backend/cmd/main.go`)
```go
type ComponentConfig struct {
    Redis struct {
        Password string `mapstructure:"password"`
    } `mapstructure:"redis"`
    RDS struct {
        Password string `mapstructure:"password"`
    } `mapstructure:"rds"`
    S3Config struct {
        AccessKey       string `mapstructure:"access_key"`
        SecretAccessKey string `mapstructure:"secret_access_key"`
    } `mapstructure:"s3_config"`
    CKConfig struct {
        Password string `mapstructure:"password"`
    } `mapstructure:"ck_config"`
}
```

#### LLM运行时配置实体 (`backend/modules/llm/domain/entity/config.go`)
```go
type RuntimeConfig struct {
    QianfanAk string `json:"qianfan_ak"`  // 千帆 AccessKey
    QianfanSk string `json:"qianfan_sk"`  // 千帆 SecretKey
}
```

#### 模型配置模板文件
发现多个模型配置模板文件，包含 API Key 配置字段：
- `backend/modules/llm/infra/config/model_repo_example/openai.yaml`
- `backend/modules/llm/infra/config/model_repo_example/claude.yaml`
- `backend/modules/llm/infra/config/model_repo_example/qianfan.yaml`
- 等其他模型配置模板

### 3.4 发现的所有敏感信息文件清单

#### 高风险文件（包含实际敏感信息）
1. `conf/default/mysql/.cnf` - MySQL数据库密码
2. `conf/default/redis/.cnf` - Redis密码
3. `conf/default/clickhouse/.cnf` - ClickHouse数据库密码
4. `conf/default/minio/.cnf` - MinIO对象存储密码
5. `conf/default/app/runtime/model_config.yaml` - 模型API密钥（已脱敏）
6. `conf/default/app/runtime/model_runtime_config.yaml` - 千帆模型密钥（已脱敏）
7. `conf/default/app/runtime/infrastructure.yaml` - 基础设施配置密码

#### 中风险文件（配置结构和模板）
8. `backend/cmd/main.go` - 敏感信息配置结构定义
9. `backend/modules/llm/domain/entity/config.go` - LLM配置结构
10. `backend/modules/llm/infra/config/model_repo_example/*.yaml` - 模型配置模板

#### 脚本文件（可能包含敏感信息处理逻辑）
11. `conf/default/mysql/entrypoint.sh` - MySQL启动脚本，读取密码配置
12. `conf/default/redis/entrypoint.sh` - Redis启动脚本
13. `conf/default/minio/entrypoint.sh` - MinIO启动脚本，处理密码环境变量
14. `conf/default/clickhouse/entrypoint.sh` - ClickHouse启动脚本

## 4. 风险评估

### 4.1 高风险项
1. **数据库密码明文存储** - 所有数据库配置文件都包含明文密码
2. **模型 API 密钥配置文件存在** - 虽然已脱敏显示为"***"，但实际运行时需要真实密钥
3. **对象存储密钥明文存储** - MinIO访问密钥和秘钥明文存储
4. **配置文件路径暴露** - 代码中硬编码了配置文件路径
5. **脚本文件处理敏感信息** - 启动脚本直接读取和使用密码配置

### 4.2 中风险项
1. **配置模板文件** - 虽然是示例，但包含敏感字段结构，可能被误用
2. **Docker配置** - 通过环境变量传递敏感信息
3. **代码中的配置结构** - 明确定义了敏感信息的存储结构

### 4.3 发现的敏感信息类型
1. **数据库认证信息**：
   - MySQL: `root/cozeloop-mysql`
   - Redis: `cozeloop-redis`
   - ClickHouse: `default/cozeloop-clickhouse`

2. **对象存储认证信息**：
   - MinIO: `root/cozeloop-minio`

3. **模型API密钥**：
   - 豆包(Ark)模型 API Key
   - OpenAI API Key
   - 千帆平台 AccessKey/SecretKey

4. **消息队列配置**：
   - RocketMQ地址配置（虽然无密码，但暴露了内部架构）

## 5. 检查建议

### 5.1 立即检查的文件
1. 查找实际的模型配置文件：
   - `model_config.yaml`
   - `model_runtime_config.yaml`
2. 检查是否存在 `.env` 文件
3. 搜索项目中所有包含 "api_key" 的文件

### 5.2 自动化检查脚本
```bash
# 搜索可能包含 API Key 的文件
find . -type f \( -name "*.yaml" -o -name "*.yml" -o -name "*.json" -o -name "*.env*" -o -name "*.cnf" \) -exec grep -l "api_key\|secret\|token\|password" {} \;

# 搜索源码中的硬编码敏感信息
grep -r -i "api_key\|secret_key\|access_key" --include="*.go" --include="*.ts" --include="*.js" .
```

## 6. 安全建议

### 6.1 短期措施
1. 将所有敏感配置移至环境变量
2. 使用配置管理工具（如 Vault）
3. 确保 `.gitignore` 包含所有敏感文件

### 6.2 长期措施
1. 实施密钥轮换机制
2. 使用加密存储敏感配置
3. 建立敏感信息扫描流水线

## 7. 最终检查结果总结

### 7.1 确认包含敏感信息的文件清单

**数据库配置文件（4个）：**
1. `conf/default/mysql/.cnf` - MySQL密码：`cozeloop-mysql`
2. `conf/default/redis/.cnf` - Redis密码：`cozeloop-redis`
3. `conf/default/clickhouse/.cnf` - ClickHouse密码：`cozeloop-clickhouse`
4. `conf/default/minio/.cnf` - MinIO密码：`cozeloop-minio`

**模型API配置文件（2个）：**
5. `conf/default/app/runtime/model_config.yaml` - 豆包和OpenAI API密钥（已脱敏）
6. `conf/default/app/runtime/model_runtime_config.yaml` - 千帆AccessKey/SecretKey（已脱敏）

**基础设施配置文件（1个）：**
7. `conf/default/app/runtime/infrastructure.yaml` - 汇总所有服务密码

**启动脚本文件（4个）：**
8. `conf/default/mysql/entrypoint.sh` - 处理MySQL密码
9. `conf/default/redis/entrypoint.sh` - 处理Redis密码
10. `conf/default/minio/entrypoint.sh` - 处理MinIO密码和环境变量
11. `conf/default/clickhouse/entrypoint.sh` - 处理ClickHouse密码

**代码文件（2个）：**
12. `backend/cmd/main.go` - 定义敏感信息配置结构
13. `backend/modules/llm/domain/entity/config.go` - LLM配置结构

**模板文件（9个）：**
14. `backend/modules/llm/infra/config/model_repo_example/openai.yaml`
15. `backend/modules/llm/infra/config/model_repo_example/claude.yaml`
16. `backend/modules/llm/infra/config/model_repo_example/qianfan.yaml`
17. `backend/modules/llm/infra/config/model_repo_example/ark.yaml`
18. `backend/modules/llm/infra/config/model_repo_example/arkbot.yaml`
19. `backend/modules/llm/infra/config/model_repo_example/deepseek.yaml`
20. `backend/modules/llm/infra/config/model_repo_example/gemini.yaml`
21. `backend/modules/llm/infra/config/model_repo_example/ollama.yaml`
22. `backend/modules/llm/infra/config/model_repo_example/qwen.yaml`

### 7.2 敏感信息风险等级

**🔴 高风险（需要立即处理）：**
- 数据库明文密码（4个.cnf文件）
- 对象存储明文密钥（MinIO配置）
- 模型API密钥配置文件（虽已脱敏，但结构暴露）

**🟡 中风险（建议优化）：**
- 配置文件路径硬编码
- 启动脚本处理敏感信息的方式
- 模型配置模板文件

**🟢 低风险（注意监控）：**
- 代码中的配置结构定义
- 评估配置文件（无敏感信息）

### 7.3 核心发现

✅ **确认发现模型API密钥配置**：项目中确实包含模型API密钥的配置文件，涉及：
- 豆包(Ark)模型API Key
- OpenAI API Key  
- 千帆平台AccessKey和SecretKey

✅ **确认发现数据库敏感信息**：所有数据库服务都有明文密码配置

✅ **确认发现对象存储密钥**：MinIO服务的访问密钥明文存储

**总计发现：22个文件包含或涉及敏感信息配置**